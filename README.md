# ChaCha20-Poly1305 AEAD Implementation in C

A Pure C implementation of the ChaCha20 stream cipher and Poly1305 message authentication code (MAC), combined to provide Authenticated Encryption with Associated Data (AEAD) functionality according to RFC 7539. The project includes a command-line file encryption tool and a test suite for validation. For background on the cryptographic concepts, see the [mathematical foundations](https://hackmd.io/@3l4w5M0JS-iPUqP2hAwDyg/AEAD) documentation.

## Core Components

- **ChaCha20 Stream Cipher** - RFC 7539 compliant encryption
- **Poly1305 MAC** - RFC 7539 compliant authentication
- **ChaCha20-Poly1305 AEAD** - Combined authenticated encryption
- **Vault File Encryption Tool** - Command-line utility with ChaCha20-Poly1305
- **Comprehensive Test Suite** - RFC compliance and robustness validation

## Project Structure

```
├── src/                    # Core library
│   ├── chacha20.h/c       # ChaCha20 implementation
│   ├── poly1305.h/c       # Poly1305 implementation
│   ├── aead.h/c           # ChaCha20-Poly1305 AEAD
│   └── common.h/c         # Common utilities
├── test/                  # Test suite
│   ├── test_chacha20.c    # ChaCha20 tests
│   ├── test_poly1305.c    # Poly1305 tests
│   └── test_aead.c        # AEAD tests
├── vault.c               # File encryption tool
└── Makefile
```

## Building and Running

```bash
# Build all components
make all

# Run tests
make test

# Build vault tool
make vault

# Clean build
make clean
```

---

## Vault File Encryption Tool

Command-line AEAD file encryption with ChaCha20-Poly1305:

```bash
# Seal file (auto-generate key)
./vault -s input.txt output.enc

# Seal with specified key
./vault -s input.txt output.enc a1b2c3d4e5f6789abcdef0123456789abcdef0123456789abcdef0123456789a

# Open file
./vault -o output.enc decrypted.txt a1b2c3d4e5f6789abcdef0123456789abcdef0123456789abcdef0123456789a
```

### Encrypted File Format

The vault tool produces encrypted files with the following binary structure:

```bash
[nonce (12 bytes)][ciphertext (variable length)][tag (16 bytes)]
```

**Security Properties:**

- Each file uses a unique random nonce (no nonce reuse)
- Authentication tag covers both the ciphertext and any associated data
- Constant-time tag verification prevents timing attacks
- Files are authenticated before decryption (fail-fast on tampering)

**Streaming Processing:** Files are processed in 8KB chunks for memory efficiency

---

## API Usage

### ChaCha20 Stream Cipher

```c
#include "src/chacha20.h"

// CHACHA20_KEY_SIZE = 32 bytes (256-bit key)
// CHACHA20_NONCE_SIZE = 12 bytes (96-bit nonce)

// Key and nonce generation
uint8_t key[CHACHA20_KEY_SIZE], nonce[CHACHA20_NONCE_SIZE];
chacha20_keygen(key);         // Generate random key
chacha20_noncegen(nonce);     // Generate random nonce

// Initialize
chacha20_ctx *ctx = chacha20_new();
chacha20_init(ctx, key, nonce, 0);

// Encrypt/Decrypt (symmetric operation)
uint8_t plaintext[] = "Hello, World!";
uint8_t ciphertext[sizeof(plaintext)];
chacha20_encrypt(ctx, plaintext, ciphertext, sizeof(plaintext));

// Safe reinitialization with new parameters
uint8_t new_key[CHACHA20_KEY_SIZE], new_nonce[CHACHA20_NONCE_SIZE];
chacha20_keygen(new_key);
chacha20_noncegen(new_nonce);
chacha20_reinit(ctx, new_key, new_nonce, 0);  // Safely reinitialize

// Process more data with new parameters
uint8_t plaintext2[] = "Another message";
uint8_t ciphertext2[sizeof(plaintext2)];
chacha20_encrypt(ctx, plaintext2, ciphertext2, sizeof(plaintext2));

// Cleanup
chacha20_clear(ctx);
chacha20_free(ctx);
```

### Poly1305 MAC

```c
#include "src/poly1305.h"

// POLY1305_KEY_SIZE = 32 bytes (256-bit key)
// POLY1305_TAG_SIZE = 16 bytes (128-bit authentication tag)

// One-shot authentication
uint8_t key[POLY1305_KEY_SIZE], tag[POLY1305_TAG_SIZE];
uint8_t data[] = "Message to authenticate";

// IMPORTANT: When using Poly1305 standalone, you MUST provide a secure key!
// - Use a cryptographically secure random number generator
// - Derive from a master key using HKDF or similar KDF
// - In ChaCha20-Poly1305, the key is derived from ChaCha20 keystream
// - NEVER reuse keys or use predictable/weak keys in production!

// Example: Assume 'key' is securely generated by your application
// generate_key(key); // Your secure key generation function
poly1305_auth(key, data, sizeof(data), tag);

// Streaming authentication
poly1305_ctx *ctx = poly1305_new();
poly1305_init(ctx, key);
poly1305_update(ctx, data, sizeof(data));
poly1305_finalize(ctx, tag);

// Verify tag
uint8_t received_tag[POLY1305_TAG_SIZE];
// ... receive tag from somewhere ...
bool valid = poly1305_verify(tag, received_tag);

// Cleanup
poly1305_clear(ctx);
poly1305_free(ctx);
```

### ChaCha20-Poly1305 AEAD

```c
#include "src/aead.h"

// AEAD_KEY_SIZE = 32 bytes (256-bit key)
// AEAD_NONCE_SIZE = 12 bytes (96-bit nonce)
// AEAD_TAG_SIZE = 16 bytes (128-bit authentication tag)
// AEAD_MAX_DATA_SIZE = 274 GB per (key, nonce) pair
// AEAD_MAX_AAD_SIZE = ~2.3 EB associated data limit

// One-shot API
uint8_t key[AEAD_KEY_SIZE], nonce[AEAD_NONCE_SIZE];
uint8_t plaintext[] = "Secret message";
uint8_t aad[] = "Associated data";

// Generate key and nonce
aead_keygen(key);
aead_noncegen(nonce);

// Seal (encrypt + authenticate)
uint8_t sealed[sizeof(plaintext) + AEAD_TAG_SIZE];
bool success = aead_seal(key, nonce,
                        aad, sizeof(aad),
                        plaintext, sizeof(plaintext),
                        sealed);

// Open (decrypt + verify)
uint8_t decrypted[sizeof(plaintext)];
success = aead_open(key, nonce,
                   aad, sizeof(aad),
                   sealed, sizeof(sealed),
                   decrypted);
```

### Streaming AEAD

```c
// Streaming seal (encryption + authentication)
aead_stream_ctx *stream = aead_stream_new();
aead_stream_seal_init(stream, key, nonce, aad, aad_len);

// Process data in chunks
while (has_data) {
    aead_stream_seal_update(stream, chunk, chunk_size, ciphertext_chunk);
}

uint8_t tag[AEAD_TAG_SIZE];
aead_stream_seal_final(stream, tag);
aead_stream_free(stream);

// Streaming open (decryption + verification)
aead_stream_ctx *stream2 = aead_stream_new();
aead_stream_open_init(stream2, key, nonce, aad, aad_len);

// Process ciphertext chunks
while (has_ciphertext_data) {
    aead_stream_open_update(stream2, ciphertext_chunk, chunk_size, plaintext_chunk);
}

// Verify authentication tag
bool authentic = aead_stream_open_final(stream2, tag);
if (!authentic) {
    // Authentication failed - data corrupted or wrong key
}

aead_stream_clear(stream2);
aead_stream_free(stream2);
```

---

## References

- [RFC 7539: ChaCha20 and Poly1305 for IETF Protocols](https://tools.ietf.org/rfc/rfc7539.txt)
- [Daniel J. Bernstein's ChaCha20 specification](https://cr.yp.to/chacha.html)
- [Original ChaCha paper](https://cr.yp.to/chacha/chacha-20080128.pdf)

## TODO

- [x] ChaCha20-Poly1305 AEAD Support - Add authenticated encryption mode
- [ ] Key Derivation Function - Integrate PBKDF2/Argon2 support for secure key generation
